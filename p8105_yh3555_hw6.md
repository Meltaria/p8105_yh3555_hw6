p8105_yh3555_hw6
================
Yuchen Hua
2022-11-28

## Problem 2

Import data

``` r
homicide = read.csv("./data./homicide-data.csv")
```

Date cleaning

``` r
homicide_clean = homicide %>%
  mutate(city_state = str_c(city, ",", state)) %>%
  mutate(city_state = as.factor(city_state)) %>%
  mutate(victim_age = as.numeric(victim_age)) %>%
  group_by(city_state, disposition) %>% 
  filter(!city_state %in% c("Dallas,TX", "Phoenix,AZ", "Kansas City,MO", "Tulsa,AL"),
         !victim_age %in% c(NA),
         !victim_sex %in% c("Unknown")) %>%
  filter(victim_race %in% c("Black", "White")) %>%
  mutate(resolved = ifelse(disposition %in% c("Closed by arrest"), 1, 0)) %>%
  select(-uid, -reported_date, -victim_last, -victim_first, -lat, -lon)
```

    ## Warning in mask$eval_all_mutate(quo): 强制改变过程中产生了NA

``` r
homicide_clean
```

    ## # A tibble: 39,362 × 8
    ## # Groups:   city_state, disposition [135]
    ##    victim_race victim_age victim_sex city        state disposi…¹ city_…² resol…³
    ##    <chr>            <dbl> <chr>      <chr>       <chr> <chr>     <fct>     <dbl>
    ##  1 White               15 Female     Albuquerque NM    Closed w… Albuqu…       0
    ##  2 White               72 Female     Albuquerque NM    Closed w… Albuqu…       0
    ##  3 White               91 Female     Albuquerque NM    Open/No … Albuqu…       0
    ##  4 White               56 Male       Albuquerque NM    Open/No … Albuqu…       0
    ##  5 White               43 Female     Albuquerque NM    Closed b… Albuqu…       1
    ##  6 White               52 Male       Albuquerque NM    Closed b… Albuqu…       1
    ##  7 White               22 Female     Albuquerque NM    Closed b… Albuqu…       1
    ##  8 Black               15 Male       Albuquerque NM    Closed b… Albuqu…       1
    ##  9 Black               25 Male       Albuquerque NM    Closed b… Albuqu…       1
    ## 10 White               20 Male       Albuquerque NM    Closed b… Albuqu…       1
    ## # … with 39,352 more rows, and abbreviated variable names ¹​disposition,
    ## #   ²​city_state, ³​resolved

If the case was closed by arrested, which was solved, it would be
labelled as 1. If Open/No arrest or Closed without arrest, it would be
labelled as 0.

For Baltimore,MD

``` r
baltimore_fit = homicide_clean %>%
  filter(city_state %in% c("Baltimore,MD")) %>%
  glm(resolved ~ victim_age + victim_race + victim_sex, data = ., family = binomial())
baltimore_fit
```

    ## 
    ## Call:  glm(formula = resolved ~ victim_age + victim_race + victim_sex, 
    ##     family = binomial(), data = .)
    ## 
    ## Coefficients:
    ##      (Intercept)        victim_age  victim_raceWhite    victim_sexMale  
    ##         0.309981         -0.006727          0.841756         -0.854463  
    ## 
    ## Degrees of Freedom: 2752 Total (i.e. Null);  2749 Residual
    ## Null Deviance:       3568 
    ## Residual Deviance: 3493  AIC: 3501

``` r
baltimore_tidy = broom::tidy(baltimore_fit)
```

The OR and CI of baltimore can be obtained.

``` r
baltimore_tidy %>%
  mutate(OR = exp(estimate),
         ci_lower = estimate + 1.96*std.error,
         ci_upper = estimate - 1.96*std.error) %>%
  select(term, log_OR = estimate, OR, p.value, ci_lower, ci_upper) %>%
  knitr::kable(digits = 3)
```

| term             | log_OR |    OR | p.value | ci_lower | ci_upper |
|:-----------------|-------:|------:|--------:|---------:|---------:|
| (Intercept)      |  0.310 | 1.363 |   0.070 |    0.646 |   -0.026 |
| victim_age       | -0.007 | 0.993 |   0.043 |    0.000 |   -0.013 |
| victim_raceWhite |  0.842 | 2.320 |   0.000 |    1.184 |    0.499 |
| victim_sexMale   | -0.854 | 0.426 |   0.000 |   -0.584 |   -1.125 |

For all cities

``` r
nest_city = homicide_clean %>%
  nest(data = -city_state) %>%
  mutate(
    models = map(data, ~glm(resolved ~ victim_age + victim_race + victim_sex, data= ., family = binomial())),
    results = map(models, broom::tidy)) %>%
  select(-data, -models) %>%
  unnest(results) %>%
  filter(term != "(Intercept)") %>%
  select(city_state, term, estimate, std.error)
```

OR an CI

``` r
nest_city %>%
   mutate(OR = exp(estimate),
         ci_lower = estimate + 1.96*std.error,
         ci_upper = estimate - 1.96*std.error) %>%
  select(term, log_OR = estimate, OR, ci_lower, ci_upper) %>%
  knitr::kable(digits = 3)
```

    ## Adding missing grouping variables: `city_state`

| city_state        | term             | log_OR |     OR | ci_lower | ci_upper |
|:------------------|:-----------------|-------:|-------:|---------:|---------:|
| Albuquerque,NM    | victim_age       | -0.020 |  0.981 |   -0.002 |   -0.037 |
| Albuquerque,NM    | victim_raceWhite |  0.412 |  1.510 |    1.228 |   -0.404 |
| Albuquerque,NM    | victim_sexMale   |  0.570 |  1.767 |    1.325 |   -0.186 |
| Atlanta,GA        | victim_age       | -0.012 |  0.988 |   -0.003 |   -0.021 |
| Atlanta,GA        | victim_raceWhite |  0.269 |  1.308 |    0.826 |   -0.289 |
| Atlanta,GA        | victim_sexMale   |  0.000 |  1.000 |    0.381 |   -0.380 |
| Baltimore,MD      | victim_age       | -0.007 |  0.993 |    0.000 |   -0.013 |
| Baltimore,MD      | victim_raceWhite |  0.842 |  2.320 |    1.184 |    0.499 |
| Baltimore,MD      | victim_sexMale   | -0.854 |  0.426 |   -0.584 |   -1.125 |
| Baton Rouge,LA    | victim_age       | -0.007 |  0.993 |    0.009 |   -0.022 |
| Baton Rouge,LA    | victim_raceWhite |  0.447 |  1.564 |    1.211 |   -0.316 |
| Baton Rouge,LA    | victim_sexMale   | -0.964 |  0.381 |   -0.363 |   -1.564 |
| Birmingham,AL     | victim_age       | -0.008 |  0.992 |    0.002 |   -0.018 |
| Birmingham,AL     | victim_raceWhite | -0.068 |  0.934 |    0.457 |   -0.593 |
| Birmingham,AL     | victim_sexMale   | -0.139 |  0.870 |    0.276 |   -0.555 |
| Boston,MA         | victim_age       | -0.004 |  0.996 |    0.014 |   -0.021 |
| Boston,MA         | victim_raceWhite |  2.365 | 10.646 |    3.271 |    1.459 |
| Boston,MA         | victim_sexMale   | -0.404 |  0.667 |    0.231 |   -1.040 |
| Buffalo,NY        | victim_age       |  0.014 |  1.015 |    0.029 |    0.000 |
| Buffalo,NY        | victim_raceWhite |  0.960 |  2.611 |    1.573 |    0.347 |
| Buffalo,NY        | victim_sexMale   | -0.653 |  0.521 |   -0.067 |   -1.239 |
| Charlotte,NC      | victim_age       | -0.001 |  0.999 |    0.012 |   -0.014 |
| Charlotte,NC      | victim_raceWhite |  0.460 |  1.584 |    1.021 |   -0.101 |
| Charlotte,NC      | victim_sexMale   | -0.123 |  0.884 |    0.338 |   -0.585 |
| Chicago,IL        | victim_age       |  0.007 |  1.007 |    0.012 |    0.002 |
| Chicago,IL        | victim_raceWhite |  0.575 |  1.778 |    0.843 |    0.307 |
| Chicago,IL        | victim_sexMale   | -0.891 |  0.410 |   -0.692 |   -1.091 |
| Cincinnati,OH     | victim_age       | -0.010 |  0.990 |    0.001 |   -0.022 |
| Cincinnati,OH     | victim_raceWhite |  1.136 |  3.114 |    1.686 |    0.586 |
| Cincinnati,OH     | victim_sexMale   | -0.917 |  0.400 |   -0.390 |   -1.444 |
| Columbus,OH       | victim_age       |  0.007 |  1.007 |    0.016 |   -0.002 |
| Columbus,OH       | victim_raceWhite |  0.164 |  1.178 |    0.465 |   -0.138 |
| Columbus,OH       | victim_sexMale   | -0.630 |  0.532 |   -0.288 |   -0.972 |
| Denver,CO         | victim_age       | -0.014 |  0.986 |    0.003 |   -0.030 |
| Denver,CO         | victim_raceWhite |  0.572 |  1.773 |    1.163 |   -0.018 |
| Denver,CO         | victim_sexMale   | -0.736 |  0.479 |   -0.030 |   -1.442 |
| Detroit,MI        | victim_age       |  0.003 |  1.003 |    0.009 |   -0.003 |
| Detroit,MI        | victim_raceWhite |  0.427 |  1.532 |    0.716 |    0.137 |
| Detroit,MI        | victim_sexMale   | -0.541 |  0.582 |   -0.310 |   -0.772 |
| Durham,NC         | victim_age       | -0.004 |  0.996 |    0.014 |   -0.022 |
| Durham,NC         | victim_raceWhite | -0.023 |  0.977 |    0.892 |   -0.938 |
| Durham,NC         | victim_sexMale   | -0.208 |  0.812 |    0.521 |   -0.936 |
| Fort Worth,TX     | victim_age       | -0.021 |  0.979 |   -0.008 |   -0.034 |
| Fort Worth,TX     | victim_raceWhite |  0.063 |  1.065 |    0.516 |   -0.390 |
| Fort Worth,TX     | victim_sexMale   | -0.402 |  0.669 |    0.120 |   -0.924 |
| Fresno,CA         | victim_age       |  0.012 |  1.012 |    0.032 |   -0.008 |
| Fresno,CA         | victim_raceWhite |  0.777 |  2.174 |    1.530 |    0.024 |
| Fresno,CA         | victim_sexMale   |  0.289 |  1.335 |    1.122 |   -0.544 |
| Houston,TX        | victim_age       | -0.009 |  0.991 |   -0.003 |   -0.015 |
| Houston,TX        | victim_raceWhite |  0.060 |  1.062 |    0.294 |   -0.173 |
| Houston,TX        | victim_sexMale   | -0.341 |  0.711 |   -0.098 |   -0.584 |
| Indianapolis,IN   | victim_age       | -0.009 |  0.991 |    0.000 |   -0.017 |
| Indianapolis,IN   | victim_raceWhite |  0.709 |  2.032 |    0.992 |    0.426 |
| Indianapolis,IN   | victim_sexMale   | -0.085 |  0.919 |    0.217 |   -0.386 |
| Jacksonville,FL   | victim_age       | -0.007 |  0.993 |    0.001 |   -0.015 |
| Jacksonville,FL   | victim_raceWhite |  0.437 |  1.547 |    0.708 |    0.165 |
| Jacksonville,FL   | victim_sexMale   | -0.329 |  0.720 |   -0.035 |   -0.623 |
| Las Vegas,NV      | victim_age       | -0.007 |  0.993 |    0.001 |   -0.015 |
| Las Vegas,NV      | victim_raceWhite |  0.252 |  1.287 |    0.548 |   -0.044 |
| Las Vegas,NV      | victim_sexMale   | -0.178 |  0.837 |    0.143 |   -0.498 |
| Long Beach,CA     | victim_age       |  0.009 |  1.009 |    0.029 |   -0.012 |
| Long Beach,CA     | victim_raceWhite | -0.048 |  0.953 |    0.750 |   -0.846 |
| Long Beach,CA     | victim_sexMale   | -0.891 |  0.410 |    0.079 |   -1.861 |
| Los Angeles,CA    | victim_age       | -0.003 |  0.997 |    0.006 |   -0.012 |
| Los Angeles,CA    | victim_raceWhite |  0.548 |  1.729 |    0.892 |    0.203 |
| Los Angeles,CA    | victim_sexMale   | -0.413 |  0.662 |   -0.045 |   -0.781 |
| Louisville,KY     | victim_age       | -0.009 |  0.991 |    0.003 |   -0.021 |
| Louisville,KY     | victim_raceWhite |  0.919 |  2.508 |    1.336 |    0.503 |
| Louisville,KY     | victim_sexMale   | -0.712 |  0.491 |   -0.236 |   -1.188 |
| Memphis,TN        | victim_age       | -0.016 |  0.984 |   -0.008 |   -0.024 |
| Memphis,TN        | victim_raceWhite |  0.217 |  1.243 |    0.620 |   -0.186 |
| Memphis,TN        | victim_sexMale   | -0.324 |  0.723 |   -0.012 |   -0.636 |
| Miami,FL          | victim_age       | -0.001 |  0.999 |    0.012 |   -0.015 |
| Miami,FL          | victim_raceWhite |  0.544 |  1.722 |    0.981 |    0.106 |
| Miami,FL          | victim_sexMale   | -0.663 |  0.515 |   -0.137 |   -1.189 |
| Milwaukee,wI      | victim_age       | -0.012 |  0.988 |   -0.003 |   -0.021 |
| Milwaukee,wI      | victim_raceWhite |  0.521 |  1.684 |    0.975 |    0.067 |
| Milwaukee,wI      | victim_sexMale   | -0.319 |  0.727 |    0.058 |   -0.696 |
| Minneapolis,MN    | victim_age       |  0.005 |  1.005 |    0.021 |   -0.010 |
| Minneapolis,MN    | victim_raceWhite |  0.496 |  1.642 |    1.135 |   -0.144 |
| Minneapolis,MN    | victim_sexMale   | -0.054 |  0.947 |    0.629 |   -0.738 |
| Nashville,TN      | victim_age       | -0.004 |  0.996 |    0.006 |   -0.014 |
| Nashville,TN      | victim_raceWhite |  0.140 |  1.150 |    0.461 |   -0.181 |
| Nashville,TN      | victim_sexMale   |  0.034 |  1.034 |    0.446 |   -0.379 |
| New Orleans,LA    | victim_age       | -0.022 |  0.978 |   -0.012 |   -0.032 |
| New Orleans,LA    | victim_raceWhite |  0.807 |  2.241 |    1.269 |    0.345 |
| New Orleans,LA    | victim_sexMale   | -0.536 |  0.585 |   -0.209 |   -0.863 |
| New York,NY       | victim_age       |  0.008 |  1.008 |    0.022 |   -0.006 |
| New York,NY       | victim_raceWhite |  0.796 |  2.216 |    1.470 |    0.122 |
| New York,NY       | victim_sexMale   | -1.338 |  0.262 |   -0.695 |   -1.981 |
| Oakland,CA        | victim_age       |  0.001 |  1.001 |    0.013 |   -0.011 |
| Oakland,CA        | victim_raceWhite |  1.710 |  5.530 |    2.430 |    0.991 |
| Oakland,CA        | victim_sexMale   | -0.574 |  0.563 |   -0.141 |   -1.008 |
| Oklahoma City,OK  | victim_age       | -0.008 |  0.992 |    0.004 |   -0.019 |
| Oklahoma City,OK  | victim_raceWhite |  0.359 |  1.431 |    0.746 |   -0.028 |
| Oklahoma City,OK  | victim_sexMale   | -0.026 |  0.974 |    0.419 |   -0.471 |
| Omaha,NE          | victim_age       |  0.004 |  1.004 |    0.021 |   -0.013 |
| Omaha,NE          | victim_raceWhite |  1.989 |  7.309 |    2.589 |    1.389 |
| Omaha,NE          | victim_sexMale   | -0.961 |  0.382 |   -0.327 |   -1.595 |
| Philadelphia,PA   | victim_age       |  0.001 |  1.001 |    0.007 |   -0.005 |
| Philadelphia,PA   | victim_raceWhite |  0.436 |  1.546 |    0.719 |    0.152 |
| Philadelphia,PA   | victim_sexMale   | -0.701 |  0.496 |   -0.427 |   -0.974 |
| Pittsburgh,PA     | victim_age       |  0.005 |  1.005 |    0.017 |   -0.008 |
| Pittsburgh,PA     | victim_raceWhite |  1.275 |  3.580 |    1.837 |    0.714 |
| Pittsburgh,PA     | victim_sexMale   | -0.842 |  0.431 |   -0.357 |   -1.328 |
| Richmond,VA       | victim_age       | -0.016 |  0.985 |    0.004 |   -0.036 |
| Richmond,VA       | victim_raceWhite |  0.700 |  2.015 |    1.719 |   -0.318 |
| Richmond,VA       | victim_sexMale   |  0.006 |  1.006 |    0.709 |   -0.697 |
| San Antonio,TX    | victim_age       | -0.014 |  0.986 |    0.000 |   -0.029 |
| San Antonio,TX    | victim_raceWhite |  0.294 |  1.342 |    0.786 |   -0.199 |
| San Antonio,TX    | victim_sexMale   | -0.350 |  0.705 |    0.222 |   -0.922 |
| Sacramento,CA     | victim_age       |  0.007 |  1.007 |    0.025 |   -0.010 |
| Sacramento,CA     | victim_raceWhite |  0.269 |  1.309 |    0.881 |   -0.343 |
| Sacramento,CA     | victim_sexMale   | -0.402 |  0.669 |    0.290 |   -1.094 |
| Savannah,GA       | victim_age       |  0.001 |  1.001 |    0.020 |   -0.018 |
| Savannah,GA       | victim_raceWhite |  0.535 |  1.708 |    1.293 |   -0.223 |
| Savannah,GA       | victim_sexMale   | -0.143 |  0.867 |    0.577 |   -0.862 |
| San Bernardino,CA | victim_age       |  0.020 |  1.020 |    0.046 |   -0.006 |
| San Bernardino,CA | victim_raceWhite |  0.013 |  1.013 |    0.899 |   -0.873 |
| San Bernardino,CA | victim_sexMale   | -0.692 |  0.500 |    0.380 |   -1.765 |
| San Diego,CA      | victim_age       | -0.005 |  0.995 |    0.011 |   -0.021 |
| San Diego,CA      | victim_raceWhite |  0.720 |  2.055 |    1.286 |    0.155 |
| San Diego,CA      | victim_sexMale   | -0.884 |  0.413 |   -0.157 |   -1.612 |
| San Francisco,CA  | victim_age       |  0.027 |  1.027 |    0.041 |    0.012 |
| San Francisco,CA  | victim_raceWhite |  0.866 |  2.378 |    1.352 |    0.380 |
| San Francisco,CA  | victim_sexMale   | -0.498 |  0.608 |    0.153 |   -1.150 |
| St. Louis,MO      | victim_age       | -0.005 |  0.995 |    0.003 |   -0.013 |
| St. Louis,MO      | victim_raceWhite |  0.552 |  1.737 |    0.904 |    0.200 |
| St. Louis,MO      | victim_sexMale   | -0.352 |  0.703 |   -0.070 |   -0.634 |
| Stockton,CA       | victim_age       |  0.001 |  1.001 |    0.019 |   -0.017 |
| Stockton,CA       | victim_raceWhite |  0.802 |  2.229 |    1.522 |    0.081 |
| Stockton,CA       | victim_sexMale   |  0.301 |  1.352 |    1.079 |   -0.476 |
| Tampa,FL          | victim_age       |  0.000 |  1.000 |    0.019 |   -0.019 |
| Tampa,FL          | victim_raceWhite | -0.212 |  0.809 |    0.485 |   -0.909 |
| Tampa,FL          | victim_sexMale   | -0.214 |  0.808 |    0.629 |   -1.056 |
| Tulsa,OK          | victim_age       | -0.009 |  0.991 |    0.003 |   -0.021 |
| Tulsa,OK          | victim_raceWhite |  0.526 |  1.693 |    0.922 |    0.131 |
| Tulsa,OK          | victim_sexMale   | -0.025 |  0.976 |    0.439 |   -0.488 |
| Washington,DC     | victim_age       | -0.007 |  0.993 |    0.002 |   -0.016 |
| Washington,DC     | victim_raceWhite |  0.652 |  1.919 |    1.337 |   -0.033 |
| Washington,DC     | victim_sexMale   | -0.370 |  0.691 |    0.018 |   -0.757 |

## Problem 3

Load and clean the data for regression analysis (i.e. convert numeric to
factor where appropriate, check for missing data, etc.).

Propose a regression model for birthweight. This model may be based on a
hypothesized structure for the factors that underly birthweight, on a
data-driven model-building process, or a combination of the two.
Describe your modeling process and show a plot of model residuals
against fitted values – use add_predictions and add_residuals in making
this plot.

Compare your model to two others:

    One using length at birth and gestational age as predictors (main effects only)
    One using head circumference, length, sex, and all interactions (including the three-way interaction) between these

Make this comparison in terms of the cross-validated prediction error;
use crossv_mc and functions in purrr as appropriate.

Note that although we expect your model to be reasonable, model building
itself is not a main idea of the course and we don’t necessarily expect
your model to be “optimal” Import data

``` r
bw = read.csv("./data/birthweight.csv")
```
