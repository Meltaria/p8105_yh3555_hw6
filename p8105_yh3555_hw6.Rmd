---
title: "p8105_yh3555_hw6"
author: "Yuchen Hua"
date: "2022-11-28"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(modelr)
library(mgcv)
library(readr)
library(ggplot2)
library(patchwork)
set.seed(1)
```


## Problem 2
Import data
```{r}
homicide = read.csv("./data./homicide-data.csv")
```

Date cleaning
```{r}
homicide_clean = homicide %>%
  mutate(city_state = str_c(city, ",", state)) %>%
  mutate(city_state = as.factor(city_state)) %>%
  mutate(victim_age = as.numeric(victim_age)) %>%
  group_by(city_state, disposition) %>% 
  filter(!city_state %in% c("Dallas,TX", "Phoenix,AZ", "Kansas City,MO", "Tulsa,AL"),
         !victim_age %in% c(NA),
         !victim_sex %in% c("Unknown")) %>%
  filter(victim_race %in% c("Black", "White")) %>%
  mutate(resolved = ifelse(disposition %in% c("Closed by arrest"), 1, 0)) %>%
  select(-uid, -reported_date, -victim_last, -victim_first, -lat, -lon)
homicide_clean
```
If the case was closed by arrested, which was solved, it would be labelled as 1. If Open/No arrest or Closed without arrest, it would be labelled as 0. 

For Baltimore,MD
```{r}
baltimore_fit = homicide_clean %>%
  filter(city_state %in% c("Baltimore,MD")) %>%
  glm(resolved ~ victim_age + victim_race + victim_sex, data = ., family = binomial())
baltimore_fit
baltimore_tidy = broom::tidy(baltimore_fit)
```
The OR and CI of baltimore can be obtained. 
```{r}
baltimore_tidy %>%
  mutate(OR = exp(estimate),
         ci_lower = exp(estimate - 1.96*std.error),
         ci_upper = exp(estimate + 1.96*std.error)) %>%
  filter(term %in% c("victim_sexMale")) %>%
  select(term, log_OR = estimate, OR, ci_lower, ci_upper) %>%
  knitr::kable(digits = 3)
```


For all cities
```{r}
nest_city = homicide_clean %>%
  nest(data = -city_state) %>%
  mutate(
    models = map(data, ~glm(resolved ~ victim_age + victim_race + victim_sex, data= ., family = binomial())),
    results = map(models, broom::tidy)) %>%
  select(-data, -models) %>%
  unnest(results) %>%
  filter(term %in% c("victim_sexMale")) %>%
  filter(term != "(Intercept)") %>%
  select(city_state, term, estimate, std.error)
```

OR an CI
```{r}
city_data = nest_city %>%
   mutate(OR = exp(estimate),
         ci_lower = exp(estimate - 1.96*std.error),
         ci_upper = exp(estimate + 1.96*std.error)) %>%
  select(term, log_OR = estimate, OR, ci_lower, ci_upper)
```

building plot
```{r}
city_data %>% 
  ggplot(aes(x = city_state, y = OR)) +
  geom_point() +
  facet_wrap(~term) + 
  theme(axis.text.x = element_text(angle = 80, hjust = 1))

```



## Problem 3
Propose a regression model for birthweight. This model may be based on a hypothesized structure for the factors that underly birthweight, on a data-driven model-building process, or a combination of the two. Describe your modeling process and show a plot of model residuals against fitted values – use add_predictions and add_residuals in making this plot.

Compare your model to two others:

    One using length at birth and gestational age as predictors (main effects only)
    One using head circumference, length, sex, and all interactions (including the three-way interaction) between these

Make this comparison in terms of the cross-validated prediction error; use crossv_mc and functions in purrr as appropriate.

Note that although we expect your model to be reasonable, model building itself is not a main idea of the course and we don’t necessarily expect your model to be “optimal”
Import data
```{r}
bw = read.csv("./data/birthweight.csv")
```
Let's hypothesize that the birthweight may have linear regression model with mother's mother's age at delivery. 
Let's clean the data
```{r}
bw_tidy = bw %>%
  select(bwt, momage) %>%
  filter(!bwt %in% c(NA),
         !momage %in% c(NA))
```

build linear model
```{r}
linear_mod1 = lm(bwt ~ momage, data = bw_tidy)
```
Build plot 
```{r}
bw_tidy %>%
  add_predictions(linear_mod1) %>%
  ggplot(aes(x = momage, y =bwt)) + geom_point(alpha = .5) + geom_line(aes(y=pred), color = "red") 
```


Let's build the other two models
```{r}
model2 = bw %>%
  select(bwt, blength, gaweeks) %>%
  filter(!bwt %in% c(NA),
         !blength %in% c(NA),
         !gaweeks %in% c(NA))
linear_model2 = lm(bwt ~ blength + gaweeks, data = model2)
```

```{r}
model3 = bw %>%
  select(bwt, bhead, blength, babysex) %>%
  filter(!bwt %in% c(NA),
         !bhead%in% c(NA),
         !blength%in% c(NA),
         !babysex %in% c(NA))
linear_model3 = lm(bwt ~ bhead + blength + babysex, data = model3)
```










